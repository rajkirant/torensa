stages:
  - build
  - deploy

variables:
  NODE_ENV: production

build_frontend:
  stage: build
  image: node:24
  script:
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/dist
    expire_in: 1 hour

deploy_branch:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build_frontend
  script:
    - apk add --no-cache git
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"

    # fresh deploy branch
    - git checkout --orphan deploy
    - git rm -rf .

    # copy backend
    - cp -r backend backend

    # copy frontend build
    - mkdir -p deploy
    - cp -r frontend/dist deploy/dist

    - git add .
    - git commit -m "Deploy build $CI_COMMIT_SHORT_SHA"
    - git push origin deploy --force
