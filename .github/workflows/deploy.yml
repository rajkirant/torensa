name: Build and Prepare Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print backend files in current commit with operation
        run: |
          echo "Files in commit $GITHUB_SHA (backend/ only):"
          git show --name-status --pretty="" "$GITHUB_SHA" | \
          grep -E "^([AMDRC]|C)[0-9]*\s+backend/" || true | \
          while IFS=$'\t' read -r status file; do
            case "$status" in
              A) op="created" ;;
              M) op="modified" ;;
              D) op="deleted" ;;
              R*|C*) op="renamed/copied" ;;
              *) op="changed ($status)" ;;
            esac
            printf "%-8s %s\n" "$op" "$file"
          done

      - name: Deploy changed backend files to PythonAnywhere
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          BACKEND_DIR="backend"
          PA_BASE_URL="https://www.pythonanywhere.com/api/v0/user/torensa/files/path/home/torensa/torensa/backend"

          echo "Processing backend file changes for commit $GITHUB_SHA"

          git show --name-status --pretty="" "$GITHUB_SHA" | \
          grep -E "^([AMDRC]|C)[0-9]*\s+backend/" || true | \
          while IFS=$'\t' read -r status file; do

            # Compute relative path inside backend/
            REL_PATH="${file#$BACKEND_DIR/}"
            PA_PATH="$PA_BASE_URL/$REL_PATH"

            case "$status" in
              A|M)
                echo "Uploading $REL_PATH ($status)"
                curl -X POST \
                  -H "Authorization: Token $PA_TOKEN" \
                  -F "content=@$file" \
                  "$PA_PATH"
                ;;
              D)
                echo "Deleting $REL_PATH"
                curl -X DELETE \
                  -H "Authorization: Token $PA_TOKEN" \
                  "$PA_PATH"
                ;;
              R*|C*)
                echo "Renamed or copied file detected: $file"
                echo "Manual review recommended for PythonAnywhere sync"
                ;;
              *)
                echo "Skipping $file (status $status)"
                ;;
            esac
          done

      # ---------- Frontend ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Delete remote deploy folder contents via Files API
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          BASE_URL="https://www.pythonanywhere.com/api/v0/user/torensa/files/path/home/torensa/torensa/deploy/dist"
          curl -X DELETE \
            -H "Authorization: Token $PA_TOKEN" $BASE_URL

      - name: Upload entire dist folder to PythonAnywhere
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          DIST_DIR="deploy/dist"
          BASE_URL="https://www.pythonanywhere.com/api/v0/user/torensa/files/path/home/torensa/torensa/deploy/dist"

          # Loop through all files in dist
          find "$DIST_DIR" -type f | while read FILE; do
            # Remove the leading deploy/dist/ to get relative path
            REL_PATH="${FILE#$DIST_DIR/}"

            echo "Uploading $REL_PATH"

            curl -X POST \
              -H "Authorization: Token $PA_TOKEN" \
              -F "content=@$FILE" \
              "$BASE_URL/$REL_PATH"
          done

      - name: Reload PythonAnywhere web app
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: Token $PA_TOKEN" \
            "https://www.pythonanywhere.com/api/v0/user/torensa/webapps/torensa.pythonanywhere.com/reload/"
