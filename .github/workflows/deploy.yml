- name: Create deploy branch
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: |
    git config user.name "github-actions"
    git config user.email "github-actions@github.com"

    # create deploy branch from main
    git checkout -B deploy

    # remove everything EXCEPT .git
    rsync -a --delete \
      --exclude '.git' \
      --exclude 'backend' \
      --exclude 'frontend/dist' \
      ./ /tmp/clean/

    # now clean working tree
    git rm -rf .

    # copy backend as-is
    cp -r backend backend

    # copy frontend build
    mkdir -p deploy
    cp -r frontend/dist deploy/dist

    git add .
    git commit -m "Deploy build ${GITHUB_SHA::7}"
    git push origin deploy --force
