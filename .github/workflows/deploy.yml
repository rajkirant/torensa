name: Build and Prepare Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect frontend changes
        id: detect_frontend
        shell: bash
        env:
          TARGET_DIR: frontend
        run: |
          echo "Before SHA: ${{ github.event.before }}"
          echo "Current SHA: ${{ github.sha }}"
          echo "Checking changes in: $TARGET_DIR/"

          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          echo "Changed files:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q "^${TARGET_DIR}/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Frontend folder changed"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Frontend folder NOT changed"
          fi

      - name: Backend files sync to PythonAnywhere
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          PA_BASE_URL="https://www.pythonanywhere.com/api/v0/user/torensa/files/path/home/torensa/torensa"

          git show --name-status --pretty="" "$GITHUB_SHA" \
          | grep -E "^([AMDRC]|C)[0-9]*\s+backend/" \
          | while IFS=$'\t' read -r status file1 file2; do

              echo "Status: $status"

              # -----------------------------
              # Added or Modified
              # -----------------------------
              if [ "$status" = "A" ] || [ "$status" = "M" ]; then
                echo "Uploading file: $file1"

                curl -X POST \
                  -H "Authorization: Token $PA_TOKEN" \
                  -F "content=@$file1" \
                  "$PA_BASE_URL/$file1"

              # -----------------------------
              # Deleted
              # -----------------------------
              elif [ "$status" = "D" ]; then
                echo "Deleting file: $file1"

                curl -X DELETE \
                  -H "Authorization: Token $PA_TOKEN" \
                  "$PA_BASE_URL/$file1"

              # -----------------------------
              # Renamed (R100, R090, etc.)
              # -----------------------------
              elif [[ "$status" == R* ]]; then
                OLD_FILE="$file1"
                NEW_FILE="$file2"

                echo "Renamed:"
                echo "  Old: $OLD_FILE"
                echo "  New: $NEW_FILE"

                # Delete old file
                curl -X DELETE \
                  -H "Authorization: Token $PA_TOKEN" \
                  "$PA_BASE_URL/$OLD_FILE"

                # Upload new file
                curl -X POST \
                  -H "Authorization: Token $PA_TOKEN" \
                  -F "content=@$NEW_FILE" \
                  "$PA_BASE_URL/$NEW_FILE"

              else
                echo "Skipping (status=$status)"
              fi

            done || true

      # ---------- Frontend ----------
      - name: Delete remote deploy folder contents via Files API
        if: steps.detect_frontend.outputs.changed == 'true'
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          BASE_URL="https://www.pythonanywhere.com/api/v0/user/torensa/files/path/home/torensa/torensa/frontend"
          curl -X DELETE \
            -H "Authorization: Token $PA_TOKEN" $BASE_URL

      - name: Setup Node.js
        if: steps.detect_frontend.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Enable Corepack and pnpm
        if: steps.detect_frontend.outputs.changed == 'true'
        run: |
          corepack enable
          corepack prepare pnpm@9.15.0 --activate

      - name: Install frontend dependencies
        if: steps.detect_frontend.outputs.changed == 'true'
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        if: steps.detect_frontend.outputs.changed == 'true'
        working-directory: frontend
        run: pnpm run build

      - name: Upload entire dist folder to PythonAnywhere
        if: steps.detect_frontend.outputs.changed == 'true'
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          DIST_DIR="frontend/dist"
          BASE_URL="https://www.pythonanywhere.com/api/v0/user/torensa/files/path/home/torensa/torensa/frontend"

          # Loop through all files in dist
          find "$DIST_DIR" -type f | while read FILE; do
            REL_PATH="${FILE#$DIST_DIR/}"
            echo "Uploading $BASE_URL/$REL_PATH"

            curl -X POST \
              -H "Authorization: Token $PA_TOKEN" \
              -F "content=@$FILE" \
              "$BASE_URL/$REL_PATH"
          done

      - name: Reload PythonAnywhere web app
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: Token $PA_TOKEN" \
            "https://www.pythonanywhere.com/api/v0/user/torensa/webapps/torensa.pythonanywhere.com/reload/"
