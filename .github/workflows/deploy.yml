name: Build and Prepare Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:

# Needed for AWS OIDC
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect frontend changes
        id: detect_frontend
        shell: bash
        env:
          TARGET_DIR: frontend
        run: |
          echo "Before SHA: ${{ github.event.before }}"
          echo "Current SHA: ${{ github.sha }}"
          echo "Checking changes in: $TARGET_DIR/"

          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          echo "Changed files:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q "^${TARGET_DIR}/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Frontend folder changed"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Frontend folder NOT changed"
          fi

      - name: Detect lambda changes
        id: detect_lambda
        shell: bash
        run: |
          echo "Before SHA: ${{ github.event.before }}"
          echo "Current SHA: ${{ github.sha }}"
          echo "Checking changes in: lambda/ or backend/"

          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          echo "Changed files:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -Eq "^(lambda|backend)/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Lambda or backend folder changed"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Lambda or backend folder NOT changed"
          fi

      - name: Backend files sync to PythonAnywhere
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          PA_BASE_URL="https://www.pythonanywhere.com/api/v0/user/torensa/files/path/home/torensa/torensa"

          git show --name-status --pretty="" "$GITHUB_SHA" \
          | grep -E "^([AMDRC]|C)[0-9]*\s+backend/" \
          | while IFS=$'\t' read -r status file1 file2; do

              echo "Status: $status"

              # -----------------------------
              # Added or Modified
              # -----------------------------
              if [ "$status" = "A" ] || [ "$status" = "M" ]; then
                echo "Uploading file: $file1"

                curl -X POST \
                  -H "Authorization: Token $PA_TOKEN" \
                  -F "content=@$file1" \
                  "$PA_BASE_URL/$file1"

              # -----------------------------
              # Deleted
              # -----------------------------
              elif [ "$status" = "D" ]; then
                echo "Deleting file: $file1"

                curl -X DELETE \
                  -H "Authorization: Token $PA_TOKEN" \
                  "$PA_BASE_URL/$file1"

              # -----------------------------
              # Renamed (R100, R090, etc.)
              # -----------------------------
              elif [[ "$status" == R* ]]; then
                OLD_FILE="$file1"
                NEW_FILE="$file2"

                echo "Renamed:"
                echo "  Old: $OLD_FILE"
                echo "  New: $NEW_FILE"

                # Delete old file
                curl -X DELETE \
                  -H "Authorization: Token $PA_TOKEN" \
                  "$PA_BASE_URL/$OLD_FILE"

                # Upload new file
                curl -X POST \
                  -H "Authorization: Token $PA_TOKEN" \
                  -F "content=@$NEW_FILE" \
                  "$PA_BASE_URL/$NEW_FILE"

              else
                echo "Skipping (status=$status)"
              fi

            done || true

      # ----------- AWS deploy ASAP (early in workflow) -----------
      - name: Configure AWS credentials (OIDC)
        if: steps.detect_frontend.outputs.changed == 'true' || steps.detect_lambda.outputs.changed == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ---------- Lambda deploy (zip) ----------
      - name: Setup Python for Lambda packaging
        if: steps.detect_lambda.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Package Lambda (zip)
        if: steps.detect_lambda.outputs.changed == 'true'
        run: |
          rm -rf lambda_package function.zip
          mkdir -p lambda_package
          python -m pip install -r backend/requirements.txt -t lambda_package
          python -m pip install -r lambda/requirements.txt -t lambda_package
          cp -r backend lambda_package/backend
          cp -r lambda lambda_package/lambda
          cd lambda_package
          zip -r ../function.zip . -x "*.pyc" -x "__pycache__/*" -x ".DS_Store"

      - name: Deploy Lambda (zip)
        if: steps.detect_lambda.outputs.changed == 'true'
        run: |
          aws lambda update-function-code \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://function.zip

      # ---------- Frontend ----------
      - name: Setup Node.js
        if: steps.detect_frontend.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Enable Corepack and pnpm
        if: steps.detect_frontend.outputs.changed == 'true'
        run: |
          corepack enable
          corepack prepare pnpm@9.15.0 --activate

      - name: Install frontend dependencies
        if: steps.detect_frontend.outputs.changed == 'true'
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      # Inject production API url for Vite build
      - name: Set Vite env (production)
        if: steps.detect_frontend.outputs.changed == 'true'
        working-directory: frontend
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" > .env.production

      - name: Build frontend
        if: steps.detect_frontend.outputs.changed == 'true'
        working-directory: frontend
        run: pnpm run build

      - name: Deploy dist to S3
        if: steps.detect_frontend.outputs.changed == 'true'
        run: |
          aws s3 sync frontend/dist/ s3://${{ secrets.S3_BUCKET_NAME }}/ --delete

      - name: Invalidate CloudFront cache
        if: steps.detect_frontend.outputs.changed == 'true'
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      # ---------- Existing PythonAnywhere frontend deploy (unchanged) ----------
      - name: Delete remote deploy folder contents via Files API
        if: steps.detect_frontend.outputs.changed == 'true'
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          BASE_URL="https://www.pythonanywhere.com/api/v0/user/torensa/files/path/home/torensa/torensa/frontend"
          curl -X DELETE \
            -H "Authorization: Token $PA_TOKEN" $BASE_URL

      - name: Upload entire dist folder to PythonAnywhere
        if: steps.detect_frontend.outputs.changed == 'true'
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          DIST_DIR="frontend/dist"
          BASE_URL="https://www.pythonanywhere.com/api/v0/user/torensa/files/path/home/torensa/torensa/frontend"

          # Loop through all files in dist
          find "$DIST_DIR" -type f | while read FILE; do
            REL_PATH="${FILE#$DIST_DIR/}"
            echo "Uploading $BASE_URL/$REL_PATH"

            curl -X POST \
              -H "Authorization: Token $PA_TOKEN" \
              -F "content=@$FILE" \
              "$BASE_URL/$REL_PATH"
          done

      - name: Reload PythonAnywhere web app
        env:
          PA_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: Token $PA_TOKEN" \
            "https://www.pythonanywhere.com/api/v0/user/torensa/webapps/torensa.pythonanywhere.com/reload/"
